#
#
#         Name: makefile (rules file for 'make') from makefile.in
#       Author: Rick Troth, rogue programmer
#         Date: 2023-07-07 (Friday) just before Israel
#         Note: this makefile configured for %SYSTEM%
#
#

APPLID          =       xfl
VERSION         =       0.7.6

#PROJECTURL     =       http://www.casita.net/pub/ductwork/src
PROJECTURL      =       http://www.casita.net/pub/xfl/src
LOCALE          =       en_US

##### configuration #####

PREFIX          =       %PREFIX%
CFLAGS          =       %CFLAGS% -DPREFIX=\"$(PREFIX)\" -I.
#LDFLAGS        =       %LDFLAGS% -L. -lxfl -lxmitmsgx
LDFLAGS         =       %LDFLAGS% -L. -lxfl
SHFLAGS         =       %SHFLAGS%
# we may later use CC, CXX, CPP, CPPFLAGS, and/or CXXFLAGS

EXE             =       
OBJ             =       .o
LIB             =       .a
DLL             =       .so

# we may later use CC, CXX, CPP, CPPFLAGS, and/or CXXFLAGS

##### configuration #####

DELIVERABLES    =       pipe$(EXE) libxfl$(LIB)

MKAR            =       $(AR) r

# identify targets without actual files to match
.PHONY:         _default all clean distclean veryclean help \
                libraries

# first target serves as the default, but name it that way anyway
_default:       $(DELIVERABLES)

all:            $(DELIVERABLES)

# pseudo target to build static and shared libraries
libraries:      libxfl$(LIB) libxfl$(DLL)

# fetch the source from GitHub
pipe.c:
		@echo "$(MAKE): you need $@"
		wget $(PROJECTURL)/$@

#
pipe$(OBJ):         makefile pipe.c
		$(CC) $(CFLAGS) -o pipe$(OBJ) -c pipe.c

#
pipe$(EXE):     makefile pipe$(OBJ) xfllib$(OBJ) xmitmsgx$(OBJ)
#		$(CC) $(LDFLAGS) -o pipe pipe$(OBJ) xfllib$(OBJ) xmitmsgx$(OBJ)
		$(CC)            -o pipe pipe$(OBJ) xfllib$(OBJ) xmitmsgx$(OBJ)

# fetch the source from GitHub
xfllib.c:
		@echo "$(MAKE): fetching the library source"
		wget $(PROJECTURL)/$@

#
xfllib$(OBJ):       xfllib.c xfl.h
		@echo "$(MAKE): compiling the library ..."
		$(CC) $(CFLAGS) -o xfllib$(OBJ) -c xfllib.c

#
libxfl$(LIB):   xfllib$(OBJ) xmitmsgx$(OBJ)
		@echo "$(MAKE): building the library ..."
		@rm -f libxfl$(LIB)
		$(MKAR) libxfl$(LIB) xfllib$(OBJ) xmitmsgx$(OBJ)

#
libxfl$(DLL):   xfllib$(OBJ)
#		$(CC) $(LDFLAGS) -shared -o libxfl$(DLL) xfllib$(OBJ)
		$(CC) $(SHFLAGS) -o libxfl$(DLL) xfllib$(OBJ)

# fetch the source from GitHub
xmitmsgx.h:
		$(MAKE) -C xmitmsgx xmitmsgx.h
		cp -p xmitmsgx/xmitmsgx.h .

#
xmitmsgx$(OBJ):
		$(MAKE) -C xmitmsgx xmitmsgx$(OBJ)
		cp -p xmitmsgx/xmitmsgx$(OBJ) .

##
#libxmitmsgx$(LIB):
#		$(MAKE) -C xmitmsgx libxmitmsgx$(LIB)
#		cp -p xmitmsgx/libxmitmsgx$(LIB) .

#
plenum$(OBJ):         makefile plenum.c
		$(CC) $(CFLAGS) -o plenum$(OBJ) -c plenum.c

#
#plenum:           makefile plenum$(OBJ) xfllib$(OBJ) xmitmsgx$(OBJ)
#		$(CC) $(LDFLAGS) -o plenum plenum$(OBJ) xfllib$(OBJ) xmitmsgx$(OBJ)
plenum$(EXE):   makefile plenum$(OBJ) libxfl$(LIB)
#		$(CC) $(LDFLAGS) -o plenum plenum$(OBJ)
		$(CC) -o plenum plenum$(OBJ) $(LDFLAGS)

########################################################################
# Rexx support
rexx:           libxflrexx$(DLL)

xflrexx$(OBJ):      makefile xflrexx.c xfl.h
		$(CC) $(CFLAGS) -o xflrexx$(OBJ) -c xflrexx.c
#		cc    -fPIC     -o xflrexx.o     -c xflrexx.c -I/usr/opt/regina/include

libxflrexx$(DLL):  xflrexx$(OBJ) xfllib$(OBJ) xmitmsgx$(OBJ)
		$(CC) $(LDFLAGS) -shared -o libxflrexx$(DLL) xflrexx$(OBJ) xfllib$(OBJ) xmitmsgx$(OBJ)
#		cc               -shared -o libxflrexx$(DLL) xflrexx.o     xfllib.o     xmitmsgx.o
#               SHFLAGS

#
# yeah, we need an "install" target
install:        $(DELIVERABLES)
		@mkdir -p $(PREFIX)/bin $(PREFIX)/lib $(PREFIX)/include \
		  $(PREFIX)/share/locale/$(LOCALE) $(PREFIX)/sbin # $(PREFIX)/src
#		cp -p xmitmsg xmiterr $(PREFIX)/bin/.
#		cp -p libxmitmsgx.a *.so $(PREFIX)/lib/.
#		cp -p xmitmsgx.h $(PREFIX)/include/.
#		cp -p xmitmsgx.msgs errno.msgs $(PREFIX)/share/locale/$(LOCALE)/.
#		cp -p xmitmivp.sh $(PREFIX)/sbin/.

#$(PREFIX)/share/locale/$(LOCALE)/$(APPLID).msgs
#$(PREFIX)/share/locale/$(LOCALE)/$(APPLID).msgs
#$(PREFIX)/lib/nls/msg/$(LOCALE)/$(APPLID).msgs
#$(PREFIX)/lib/locale/$(LOCALE)/$(APPLID).msgs
#$(PREFIX)/share/nls/$(LOCALE)/$(APPLID).msgs

#
makefile:       makefile.in configure
	@echo "$(MAKE): makefile is out of synch"
	@echo "$(MAKE): you need to re-run ./configure"
	@false

# fetch the sources from GitHub
makefile.in:
		@echo "$(MAKE): you need $@"
		wget $(PROJECTURL)/$@

configure:
		@echo "$(MAKE): you need $@"
		wget $(PROJECTURL)/$@

# reset things for a fresh build from source
clean:
		rm -f *.o *.a *.so *.dylib *.rpm *.class *$(LIB) *$(DLL) $(OBJ)
		-$(MAKE) -C xmitmsgx clean
		-$(MAKE) -C stages clean

distclean:      clean
		@rm -f configure.h configure.sh
		-$(MAKE) -C xmitmsgx distclean
		-$(MAKE) -C stages distclean

veryclean:      distclean

help:


#
# 'make' tips:
# $@ is the target
# $+ is the list of dependencies but does not work everywhere
#


